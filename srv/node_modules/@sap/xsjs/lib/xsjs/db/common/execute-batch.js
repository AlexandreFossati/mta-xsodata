'use strict';

var _ = require('lodash');

module.exports = executeBatch;

function executeBatch(stmt, args, cb) {
  stmt.executeBatch(args, function (err) {
    var statuses = stmt.getRowStatus();

    if (!err) {
      return cb(null, statuses);
    }

    var allFailed = statuses.every(function (value) {
      return value < 0;
    });

    if (allFailed) {
      return cb(err);
    }

    if (!_.isNumber(err.code)) {
      return cb(err);
    }

    var code = -Math.abs(err.code);
    statuses = statuses.map(function (value) {
      return (value < 0) ? code : value;
    });

    cb(null, statuses);
  });
}
